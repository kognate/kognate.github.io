<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Pretty/Trivial</title>
        <link rel="stylesheet" href="http://www.prettytrivial.com/theme/css/main.css" />
        <link href="http://www.prettytrivial.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Pretty/Trivial Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://www.prettytrivial.com/">Pretty/Trivial </a></h1>
                <nav><ul>
                    <li><a href="http://www.prettytrivial.com/pages/contact.html">Contact</a></li>
                    <li><a href="http://www.prettytrivial.com/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://www.prettytrivial.com/python-mocking-testing.html">Mocking and refactoring for Testing in Python</a></h1>
<footer class="post-info">
        <abbr class="published" title="2018-01-06T00:00:00-05:00">
                Published: Sat 06 January 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://www.prettytrivial.com/author/joshua-b-smith.html">Joshua B. Smith</a>
        </address>
<p>In <a href="http://www.prettytrivial.com/category/python.html">Python</a>.</p>
<p>tags: <a href="http://www.prettytrivial.com/tag/testing.html">testing</a> <a href="http://www.prettytrivial.com/tag/mocking.html">mocking</a> <a href="http://www.prettytrivial.com/tag/python.html">python</a> </p>
</footer><!-- /.post-info --><h1>The Problem</h1>
<p>(note: the full example can be found
<a href="https://gist.github.com/kognate/ec3efec9b923b1714a05c3a2d151636c">here</a>).</p>
<p>I was doing a code review and I came to the following function:</p>
<div class="highlight"><pre><span></span>def send_email(email_from, email_to, email_subject, email_msg):
    email_msg = MIMEText(email_msg)
    email_msg[&#39;Subject&#39;] = email_subject
    email_msg[&#39;From&#39;] = email_from
    email_msg[&#39;To&#39;] = email_to

    try:
        smtpObj = smtplib.SMTP(os.getenv(&#39;SMTP_SERVER&#39;))
        smtpObj.sendmail(email_from, email_to.split(&#39;,&#39;), email_msg.as_string())
        smtpObj.quit()
    except smtplib.SMTPException as exc:
        error = exc.args
        error_msg = error.message
        print(error_msg)
</pre></div>


<p>There were no tests for this function,  and I couldn't really think of
how best to test it myself. That is usually a sign that the code is
not awesome and should be refactored.</p>
<p>How?  With <code>with</code>!</p>
<h1>A potential solution</h1>
<p><code>smtplib</code> supports <code>with</code> and automatically closes the connection
when used.  The old function would silently swallow any
SMTPException which is never a good choice.</p>
<div class="highlight"><pre><span></span>def send_email(email_from, email_to, email_subject, email_msg):

    with smtplib.SMTP(os.getenv(&#39;SMTP_SERVER&#39;),&#39;localhost&#39;) as smtpObj:
        email_msg = MIMEText(email_msg)
        email_msg[&#39;Subject&#39;] = email_subject
        email_msg[&#39;From&#39;] = email_from
        email_msg[&#39;To&#39;] = email_to
        smtpObj.sendmail(email_from, email_to.split(&#39;,&#39;), email_msg.as_string())
</pre></div>


<p>But this still leaves open the question of how to test this.  I don't
want to actually send an email every time the tests are run.  The
solution to that comes from the <code>mock</code> package in <code>unittest</code>.</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">TestFunction</span><span class="p">(</span><span class="nx">TestCase</span><span class="p">)</span><span class="o">:</span>

    <span class="kd">@patch</span><span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="nx">smtplib</span><span class="p">.</span><span class="nx">SMTP</span><span class="p">,</span> <span class="s1">&#39;sendmail&#39;</span><span class="p">)</span>
    <span class="kd">@patch</span><span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="nx">smtplib</span><span class="p">.</span><span class="nx">SMTP</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>
    <span class="nx">def</span> <span class="nx">test_send_email</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">mock_close</span><span class="p">,</span> <span class="nx">mock_sendmail</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">test_message</span> <span class="o">=</span> <span class="nx">MIMEText</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
        <span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEST&#39;</span>
        <span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;testuser@test.com&#39;</span>
        <span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;testuser@test.com,testuser2@test.com&#39;</span>

        <span class="nx">send_email</span><span class="p">(</span><span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">],</span>
                   <span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;TO&#39;</span><span class="p">],</span>
                   <span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;hello&#39;</span><span class="p">)</span>
        <span class="nx">mock_close</span><span class="p">.</span><span class="nx">assert_called</span><span class="p">()</span>
        <span class="nx">mock_sendmail</span><span class="p">.</span><span class="nx">assert_called_with</span><span class="p">(</span><span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">],</span>
                                         <span class="nx">test_message</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                                         <span class="nx">test_message</span><span class="p">.</span><span class="nx">as_string</span><span class="p">())</span>
</pre></div>


<p>The <code>mock</code> library includes the ability to <code>patch</code> an existing class
(including a class I don't own).  When I patch an object, I replace
one (or more) of its methods with a new,  fake method.  </p>
<p>This example uses the <code>@patch</code> decorator to replace two methods on
the <code>SMTP</code> class.  The fist one, <code>close</code> (because decorators are
applied in reverse order) must be overridden because close is
automatically called when the block exits.
The second, <code>sendmail</code> I call explicitly.</p>
<p>When using <code>patch</code> I can check to make sure
the method and its arguments have been called correctly. The new
function now is easily testable and I don't have to provide a working
SMTP server for my tests.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://www.prettytrivial.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/kognate">kognate on Github</a></li>
                            <li><a href="https://stackoverflow.com/users/story/118803">Stack Overflow</a></li>
                            <li><a href="https://micro.blog/kognate">Micro.Blog</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>